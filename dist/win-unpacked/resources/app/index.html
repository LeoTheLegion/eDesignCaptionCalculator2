<!DOCTYPE html>
  <html>
    <head>
      <meta charset="UTF-8">
      <title>eDesignCaptionCalculator2</title>
		<script>window.$ = window.jQuery = require('jquery');</script>
    </head>
    <body>
      <h1>eDesignCaptionCalculator2</h1>
		<form id="main">
			<div>
				<label for="zip">Input Zipped File(With no spaces in filename):</label>
				<input type="file"
					   id="zip" name="zip"
					   accept=".zip" />
				<br>Rate:<input type="number" id="rate" value="1.00" step=".01"/>
				<br>
				<input type="submit" value="Send Request">
			</div>
		</form>
		<div id="unzippedHtml"></div>
		<div id="target">
		</div>
    </body>
	<script>
		
		
		const electron = require('electron');
		const {ipcRenderer} = require('electron')
		
		var pdfFileName = ""
		
		function getTableData (table,x,y){
			var rows = $(table).children('tbody').children('tr').toArray();
			try{
				var col = $(rows[y]).children('td').toArray()
			}
			catch(err) {
			   return null
			}
			try{
				return $(col[x]).text();
			}
			catch(err) {
			   return null
			}
			
		}
		
		function writeTable(arr) {
		    // cache <tbody> element:
			
		    var tbody = $('<tbody id ="newtable"></tbody>');
		    for (var i = 0; i < arr.length ; i++) {
					var row = $("<tr class='c3'></tr>")
					for (var j = 0; j < 3 ; j++) {
						var col = $("<td class='c8' colspan='1' rowspan='1'></td>");
						col.html("<p class='c5'>" + arr[i][j]) + "</p>" ;
						row.append(col);
					}
					tbody.append(row)
		        }
			$("#target").html("<table class='c14'>"+tbody.html() + "</table>");
		}
		
		function convertTimeToCost(time,rate){
			var hms = time.split(":");
			
			var hour = parseFloat(hms[0]);
			var min = parseFloat(hms[1]) ;
			var sec = parseFloat(hms[2]);
			
			min += (hour * 60) + (sec/60);
			
			return  parseFloat((min * rate).toFixed(2));
		}
		///////////////////////////////////////////////////////////////////////////////////
		document.getElementById('main').onsubmit = e => {
		   e.preventDefault();
		   const {ipcRenderer} = require('electron')
		   try{
		   		file = document.getElementById('zip').files[0].path
				if(document.getElementById('zip').files[0].type.indexOf("zip") ==  -1){
					alert("This is not a MediaSite Zip file....");
					return;
				}
		   }
		   catch(err){
		   		alert("You should probably add the MediaSite Zip first....");
				return;
		   }
		   pdfFileName = file.replace(/^.*[\\\/]/, '').slice(0,-4);
		   ipcRenderer.send('file.zip', file);
		};
		
		ipcRenderer.on('file.html', function (event, htmlFILE) {
			console.log( "Ren: "+htmlFILE );
			var s = htmlFILE + " table";
			//$('#unzippedHtml').load(s);
			//alert(__dirname)
			$( "#unzippedHtml" ).load( s, function( response, status, xhr ) {
			  if ( status == "error" ) {
			  		alert("Are you sure this a MediaSite Zip....?");
			  }
			});
			
		});
		
		$('#unzippedHtml').bind("DOMSubtreeModified",function(){
		  //alert('changed');
		  
		   var table =  $('#unzippedHtml table:nth-child(2)');
			var i = 1
			var arr = []
			var total = 0
			var rate = parseFloat($("#rate").val());
			console.log( rate );
			while (getTableData(table,1,i) != ""){
				var name = getTableData(table,1,i);
				var time =  getTableData(table,3,i);
				
				var cost =  convertTimeToCost(time,rate)
				total += cost;
				arr.push([getTableData(table,1,i) ,getTableData(table,3,i),cost]);
				i += 1;
			}
			arr.push(["TOTAL" ,"",total.toFixed(2)]);
			console.log( arr );
			writeTable(arr);
			
			var jsPDF = require('jspdf');
			require('jspdf-autotable');
			
			 var columns = ["Name", "Time", "Cost"];
			 
			// Only pt supported (not mm or in)
			var doc = new jsPDF('p', 'pt');
			var h =  $("#unzippedHtml table:nth-child(1)").html()
			doc.fromHTML("<table cellpadding='10'>"+h +"</table>");
			doc.autoTable(columns, arr,{
				margin: {top: 135}
			});
			doc.save(pdfFileName+'_CCCost.pdf');
			
			var fs = require('fs');
			var filePath = __dirname +  'test.html'; 
			fs.unlinkSync(filePath);
			
		});
		ipcRenderer.on('log', function (event, log) {
			  		alert(log);
			});
		
	</script>
  </html>